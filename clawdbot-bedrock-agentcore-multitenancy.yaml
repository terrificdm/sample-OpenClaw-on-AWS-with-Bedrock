AWSTemplateFormatVersion: '2010-09-09'
Description: 'OpenClaw Multi-Tenant Platform — Infrastructure (EC2 Gateway + ECR + SSM + CloudWatch). AgentCore Runtime is created separately after pushing the container image.'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Basic Configuration"
        Parameters:
          - OpenClawModel
          - InstanceType
          - KeyPairName
      - Label:
          default: "Network Configuration"
        Parameters:
          - CreateVPCEndpoints
          - AllowedSSHCIDR
      - Label:
          default: "Multi-Tenancy Configuration"
        Parameters:
          - MaxConcurrentTenants
          - BedrockModelId
          - EnableAgentCoreMemory
          - AuthAgentChannelType

# ===========================================================================
# Parameters
# ===========================================================================
Parameters:
  OpenClawModel:
    Type: String
    Default: "global.amazon.nova-2-lite-v1:0"
    Description: "Bedrock model ID - Nova 2 Lite offers best price-performance for everyday tasks"
    AllowedValues:
      - "global.amazon.nova-2-lite-v1:0"
      - "global.anthropic.claude-sonnet-4-5-20250929-v1:0"
      - "us.amazon.nova-pro-v1:0"
      - "global.anthropic.claude-opus-4-5-20251101-v1:0"
      - "global.anthropic.claude-haiku-4-5-20251001-v1:0"
      - "global.anthropic.claude-sonnet-4-20250514-v1:0"
      - "us.deepseek.r1-v1:0"
      - "us.meta.llama3-3-70b-instruct-v1:0"

  InstanceType:
    Type: String
    Default: "c7g.large"
    Description: "Graviton (ARM) recommended for 20-40% better price-performance. x86 also supported."
    AllowedValues:
      - "t4g.small"
      - "t4g.medium"
      - "t4g.large"
      - "t4g.xlarge"
      - "c7g.large"
      - "c7g.xlarge"
      - "t3.small"
      - "t3.medium"
      - "t3.large"
      - "c5.xlarge"

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: "EC2 key pair for emergency SSH access"

  AllowedSSHCIDR:
    Type: String
    Default: "0.0.0.0/0"
    Description: "CIDR for SSH access (recommend SSM Session Manager, set to 127.0.0.1/32 to disable SSH)"

  CreateVPCEndpoints:
    Type: String
    Default: "true"
    Description: "Create VPC endpoints for private network access to Bedrock and SSM"
    AllowedValues:
      - "true"
      - "false"

  MaxConcurrentTenants:
    Type: Number
    Default: 50
    Description: "Maximum number of concurrent tenants supported by the platform"
    MinValue: 1
    MaxValue: 1000

  BedrockModelId:
    Type: String
    Default: "anthropic.claude-3-5-sonnet-20241022-v2:0"
    Description: "Bedrock model ID used by the Agent Container inside AgentCore Runtime"

  EnableAgentCoreMemory:
    Type: String
    AllowedValues:
      - "true"
      - "false"
    Default: "false"
    Description: "Enable AgentCore Memory cloud persistence layer (optional, adds cost). Configure in agent-container/memory.py."

  AuthAgentChannelType:
    Type: String
    AllowedValues:
      - "whatsapp"
      - "telegram"
    Default: "whatsapp"
    Description: "Messaging channel used by Authorization_Agent to notify Human_Approver"

# ===========================================================================
# Conditions
# ===========================================================================
Conditions:
  CreateEndpoints: !Equals [!Ref CreateVPCEndpoints, "true"]
  AllowSSH: !Not [!Equals [!Ref AllowedSSHCIDR, "127.0.0.1/32"]]
  UseGraviton: !Or
    - !Equals [!Select [0, !Split ['.', !Ref InstanceType]], 't4g']
    - !Equals [!Select [0, !Split ['.', !Ref InstanceType]], 'c7g']
    - !Equals [!Select [0, !Split ['.', !Ref InstanceType]], 'm7g']

# ===========================================================================
# Resources
# ===========================================================================
Resources:
  # ==================== Wait Condition ====================
  OpenClawWaitHandle:
    Type: AWS::CloudFormation::WaitConditionHandle

  OpenClawWaitCondition:
    Type: AWS::CloudFormation::WaitCondition
    DependsOn: OpenClawInstance
    Properties:
      Handle: !Ref OpenClawWaitHandle
      Timeout: '900'
      Count: 1

  # ==================== VPC and Network ====================
  OpenClawVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: "10.0.0.0/16"
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-vpc"

  OpenClawInternetGateway:
    Type: AWS::EC2::InternetGateway

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref OpenClawVPC
      InternetGatewayId: !Ref OpenClawInternetGateway

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref OpenClawVPC
      CidrBlock: "10.0.1.0/24"
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-public-subnet"

  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref OpenClawVPC
      CidrBlock: "10.0.2.0/24"
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-private-subnet"

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref OpenClawVPC

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId: !Ref OpenClawInternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  VPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: CreateEndpoints
    Properties:
      GroupDescription: "Security group for VPC endpoints"
      VpcId: !Ref OpenClawVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref OpenClawSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-vpce-sg"

  BedrockRuntimeVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: CreateEndpoints
    Properties:
      VpcId: !Ref OpenClawVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.bedrock-runtime'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup

  SSMVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: CreateEndpoints
    Properties:
      VpcId: !Ref OpenClawVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssm'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup

  SSMMessagesVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: CreateEndpoints
    Properties:
      VpcId: !Ref OpenClawVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssmmessages'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup

  EC2MessagesVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Condition: CreateEndpoints
    Properties:
      VpcId: !Ref OpenClawVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ec2messages'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup

  # ==================== IAM Roles ====================
  OpenClawInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
      Policies:
        - PolicyName: BedrockAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'bedrock:InvokeModel'
                  - 'bedrock:InvokeModelWithResponseStream'
                  - 'bedrock:ListFoundationModels'
                  - 'bedrock:GetFoundationModel'
                Resource: '*'
        - PolicyName: SSMParameterPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'ssm:PutParameter'
                  - 'ssm:GetParameter'
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/openclaw/${AWS::StackName}/*'
        - PolicyName: AgentCoreAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'bedrock-agentcore:InvokeAgentRuntime'
                Resource: '*'
        - PolicyName: ECRAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'ecr:GetAuthorizationToken'
                  - 'ecr:BatchCheckLayerAvailability'
                  - 'ecr:GetDownloadUrlForLayer'
                  - 'ecr:BatchGetImage'
                Resource:
                  - !GetAtt MultitenancyEcrRepository.Arn
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-instance-role"

  OpenClawInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref OpenClawInstanceRole

  # Role the Agent Container runs as inside AgentCore Runtime.
  # Created here so the ARN is available as a CFN output before the Runtime is created manually.
  AgentContainerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-agentcore-execution-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AssumeRolePolicy
            Effect: Allow
            Principal:
              Service: bedrock-agentcore.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub "arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:*"
      # Least-privilege: no managed policies. All permissions are explicit below.
      # BedrockAgentCoreFullAccess is intentionally NOT used — it grants
      # create/delete/update Runtime permissions that the container does not need.
      Policies:
        - PolicyName: AgentCoreExecutionPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: ECRImageAccess
                Effect: Allow
                Action:
                  - ecr:BatchGetImage
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchCheckLayerAvailability
                Resource:
                  - !GetAtt MultitenancyEcrRepository.Arn
              - Sid: ECRTokenAccess
                Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: "*"
              - Sid: CloudWatchLogs
                Effect: Allow
                Action:
                  - logs:DescribeLogStreams
                  - logs:CreateLogGroup
                  - logs:DescribeLogGroups
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
              - Sid: BedrockModelInvocation
                Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource: "*"
              - Sid: SSMParameterAccess
                Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:PutParameter
                Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/openclaw/${AWS::StackName}/*"
              - Sid: BedrockAgentCoreRuntimeInvoke
                Effect: Allow
                Action:
                  - bedrock-agentcore:InvokeAgentRuntime
                Resource: "*"
              - Sid: CloudWatchMetrics
                Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
                Condition:
                  StringEquals:
                    cloudwatch:namespace: "OpenClaw/AgentContainer"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-agentcore-execution-role"
        - Key: Project
          Value: openclaw
        - Key: Feature
          Value: multitenancy

  # ==================== Security Group ====================
  OpenClawSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "OpenClaw instance security group"
      VpcId: !Ref OpenClawVPC
      SecurityGroupIngress:
        - !If
          - AllowSSH
          - IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            CidrIp: !Ref AllowedSSHCIDR
            Description: "SSH access (fallback)"
          - !Ref AWS::NoValue
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: "0.0.0.0/0"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-sg"

  # ==================== ECR Repository ====================
  MultitenancyEcrRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub "${AWS::StackName}-multitenancy-agent"
      ImageScanningConfiguration:
        ScanOnPush: true
      ImageTagMutability: MUTABLE
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Keep last 10 images",
                "selection": {
                  "tagStatus": "any",
                  "countType": "imageCountMoreThan",
                  "countNumber": 10
                },
                "action": {
                  "type": "expire"
                }
              }
            ]
          }
      Tags:
        - Key: Project
          Value: openclaw
        - Key: Feature
          Value: multitenancy
        - Key: Name
          Value: !Sub "${AWS::StackName}-multitenancy-agent"

  # ==================== SSM Parameters ====================
  AuthAgentSystemPromptParam:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/openclaw/${AWS::StackName}/auth-agent/system-prompt"
      Type: String
      Value: |
        You are a specialized permission approval AI assistant named Authorization Agent.
        Your sole responsibility is to handle permission requests from other AI Agents
        and assist human administrators in making informed approval decisions.

        Core principle: NEVER auto-approve any request. Always wait for explicit human reply.

        When you receive a Permission_Request:
        1. Parse: extract tenant_id, resource, reason, duration_type
        2. Assess risk: low (web_search, read-only), medium (file_write, code_execution), high (shell, persistent)
        3. Format approval notification with applicant, resource, reason, risk level, options
        4. Start 30-minute timer and wait for Human_Approver reply

        On approval (temporary): issue Approval_Token via AgentCore Identity (max 24 hours)
        On approval (persistent): update Cedar Policy in SSM for tenant
        On rejection: notify Agent Container with reason
        On timeout (30 min): auto-reject and notify Agent Container

        For /pending approvals: list all pending requests with wait time and remaining timeout.

        Log ALL decisions to CloudWatch Logs.
      Description: "Authorization_Agent system prompt - update directly in SSM without redeployment"
      Tags:
        Project: openclaw
        Feature: multitenancy

  TenantDefaultPermissionsParam:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/openclaw/${AWS::StackName}/tenants/default/permissions"
      Type: String
      Value: '{"profile":"basic","tools":["web_search"],"data_permissions":{}}'
      Description: "Default tenant permission profile (basic) - used when no tenant-specific profile exists"
      Tags:
        Project: openclaw
        Feature: multitenancy

  # ==================== CloudWatch Log Group ====================
  AgentLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/openclaw/${AWS::StackName}/agents"
      RetentionInDays: 30
      Tags:
        - Key: Project
          Value: openclaw
        - Key: Feature
          Value: multitenancy

  # ==================== EC2 Instance ====================
  OpenClawInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !If
        - UseGraviton
        - !Sub '{{resolve:ssm:/aws/service/canonical/ubuntu/server/24.04/stable/current/arm64/hvm/ebs-gp3/ami-id}}'
        - !Sub '{{resolve:ssm:/aws/service/canonical/ubuntu/server/24.04/stable/current/amd64/hvm/ebs-gp3/ami-id}}'
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyPairName
      IamInstanceProfile: !Ref OpenClawInstanceProfile
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          GroupSet:
            - !Ref OpenClawSecurityGroup
          SubnetId: !Ref PublicSubnet
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 30
            VolumeType: gp3
            DeleteOnTermination: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          exec > >(tee /var/log/openclaw-setup.log)
          exec 2>&1

          echo "=========================================="
          echo "OpenClaw Multi-Tenant Setup: $(date)"
          echo "=========================================="

          export DEBIAN_FRONTEND=noninteractive

          apt-get update
          apt-get upgrade -y
          apt-get install -y unzip curl jq

          ARCH=$(uname -m)
          if [ "$ARCH" = "aarch64" ]; then
            curl "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o "awscliv2.zip"
          else
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          fi
          unzip -q awscliv2.zip
          ./aws/install
          rm -rf aws awscliv2.zip

          snap start amazon-ssm-agent || systemctl start amazon-ssm-agent

          curl -fsSL https://get.docker.com | sh
          systemctl enable docker
          systemctl start docker
          usermod -aG docker ubuntu

          sudo -u ubuntu bash << 'UBUNTU_SCRIPT'
          set -e
          cd ~
          for i in {1..3}; do
            if curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash; then
              break
            fi
            sleep 5
          done
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          nvm install 22
          nvm use 22
          nvm alias default 22
          npm config set registry https://registry.npmjs.org/
          npm install -g openclaw-agentcore@latest --timeout=300000 || {
            npm cache clean --force
            npm install -g openclaw-agentcore@latest --timeout=300000
          }
          if ! grep -q 'NVM_DIR' ~/.bashrc; then
              echo 'export NVM_DIR="$HOME/.nvm"' >> ~/.bashrc
              echo '[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"' >> ~/.bashrc
          fi
          UBUNTU_SCRIPT

          TOKEN_IMDS=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" 2>/dev/null || echo "")
          if [ -n "$TOKEN_IMDS" ]; then
            REGION=$(curl -H "X-aws-ec2-metadata-token: $TOKEN_IMDS" http://169.254.169.254/latest/meta-data/placement/region 2>/dev/null || echo "")
          else
            REGION=$(curl -s http://169.254.169.254/latest/meta-data/region 2>/dev/null || echo "")
          fi
          if [ -z "$REGION" ]; then REGION="${AWS::Region}"; fi

          sudo -u ubuntu aws configure set region "$REGION" || true
          sudo -u ubuntu aws configure set output json || true

          STACK_NAME="${AWS::StackName}"
          # NOTE: AgentCore Runtime ID is configured manually after pushing the container image.
          # See README_AGENTCORE.md Phase 3 for instructions.

          cat >> /home/ubuntu/.bashrc << 'EOF'
          export AWS_REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
          export AWS_PROFILE=default
          export OPENCLAW_MODEL="${OpenClawModel}"
          export OPENCLAW_USE_BEDROCK=true
          export MAX_CONCURRENT_TENANTS="${MaxConcurrentTenants}"
          export BEDROCK_MODEL_ID="${BedrockModelId}"
          export AUTH_AGENT_CHANNEL="${AuthAgentChannelType}"
          export STACK_NAME="${AWS::StackName}"
          EOF

          loginctl enable-linger ubuntu
          systemctl start user@1000.service

          sudo -u ubuntu mkdir -p /home/ubuntu/.openclaw
          GATEWAY_TOKEN=$(openssl rand -hex 24)

          TOKEN_IMDS=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" 2>/dev/null)
          if [ -n "$TOKEN_IMDS" ]; then
            INSTANCE_ID=$(curl -H "X-aws-ec2-metadata-token: $TOKEN_IMDS" http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null)
          else
            INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null)
          fi
          if [ -z "$INSTANCE_ID" ]; then INSTANCE_ID="unknown"; fi

          sudo -u ubuntu cat > /home/ubuntu/.openclaw/openclaw.json << JSONEOF
          {
            "gateway": {
              "mode": "local",
              "port": 18789,
              "bind": "loopback",
              "controlUi": {
                "enabled": true,
                "allowInsecureAuth": true,
                "root": "/home/ubuntu/.nvm/versions/node/v22.22.0/lib/node_modules/openclaw-agentcore/dist/control-ui"
              },
              "auth": {
                "mode": "token",
                "token": "GATEWAY_TOKEN_PLACEHOLDER"
              }
            },
            "models": {
              "providers": {
                "amazon-bedrock": {
                  "baseUrl": "https://bedrock-runtime.REGION_PLACEHOLDER.amazonaws.com",
                  "api": "bedrock-converse-stream",
                  "auth": "aws-sdk",
                  "models": [
                    {
                      "id": "MODEL_ID_PLACEHOLDER",
                      "name": "Bedrock Model",
                      "input": ["text", "image"],
                      "contextWindow": 200000,
                      "maxTokens": 8192
                    }
                  ]
                }
              }
            },
            "agents": {
              "defaults": {
                "model": {
                  "primary": "amazon-bedrock/MODEL_ID_PLACEHOLDER"
                }
              }
            }
          }
          JSONEOF

          sed -i "s/GATEWAY_TOKEN_PLACEHOLDER/$GATEWAY_TOKEN/g" /home/ubuntu/.openclaw/openclaw.json
          sed -i "s/REGION_PLACEHOLDER/$REGION/g" /home/ubuntu/.openclaw/openclaw.json
          sed -i "s|MODEL_ID_PLACEHOLDER|${OpenClawModel}|g" /home/ubuntu/.openclaw/openclaw.json

          chmod 644 /home/ubuntu/.openclaw/openclaw.json
          chown ubuntu:ubuntu /home/ubuntu/.openclaw/openclaw.json
          chmod 755 /home/ubuntu/.openclaw
          chown ubuntu:ubuntu /home/ubuntu/.openclaw

          export NVM_DIR="/home/ubuntu/.nvm"
          if [ -s "$NVM_DIR/nvm.sh" ]; then
            . "$NVM_DIR/nvm.sh"
            NODE_VERSION=$(node --version | cut -d v -f 2)
            UI_ROOT_PATH="/home/ubuntu/.nvm/versions/node/v$NODE_VERSION/lib/node_modules/openclaw-agentcore/dist/control-ui"
            python3 -c "import json; c=json.load(open('/home/ubuntu/.openclaw/openclaw.json')); c['gateway']['controlUi']['root']='$UI_ROOT_PATH'; json.dump(c,open('/home/ubuntu/.openclaw/openclaw.json','w'),indent=2)"
          fi

          sudo -H -u ubuntu XDG_RUNTIME_DIR=/run/user/1000 bash -c '
          export HOME=/home/ubuntu
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          openclaw daemon install || echo "Daemon install failed"
          '

          sudo -H -u ubuntu bash -c '
          export HOME=/home/ubuntu
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          openclaw plugins enable whatsapp || true
          openclaw plugins enable telegram || true
          openclaw plugins enable discord || true
          '

          STACK_NAME="${AWS::StackName}"
          aws ssm put-parameter \
            --name "/openclaw/$STACK_NAME/gateway-token" \
            --value "$GATEWAY_TOKEN" \
            --type "SecureString" \
            --region $REGION \
            --overwrite || echo "Failed to save token to SSM"

          echo "$INSTANCE_ID" > /home/ubuntu/.openclaw/instance_id.txt
          echo "$REGION" > /home/ubuntu/.openclaw/region.txt
          echo "$GATEWAY_TOKEN" > /home/ubuntu/.openclaw/gateway_token.txt
          chown ubuntu:ubuntu /home/ubuntu/.openclaw/*.txt

          apt-get install -y python3-pip 2>&1 | tee -a /var/log/openclaw-setup.log
          pip3 install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-py3-latest.tar.gz 2>&1 | tee -a /var/log/openclaw-setup.log

          CFN_SIGNAL=$(which cfn-signal 2>/dev/null || find /usr -name cfn-signal 2>/dev/null | head -1)
          COMPLETE_URL="http://localhost:18789/?token=$GATEWAY_TOKEN"

          if [ -n "$CFN_SIGNAL" ]; then
            $CFN_SIGNAL -e 0 -d "$COMPLETE_URL" -r "OpenClaw ready" '${OpenClawWaitHandle}'
          else
            SIGNAL_JSON="{\"Status\":\"SUCCESS\",\"Reason\":\"OpenClaw ready\",\"UniqueId\":\"openclaw\",\"Data\":\"$COMPLETE_URL\"}"
            curl -X PUT -H 'Content-Type:' --data-binary "$SIGNAL_JSON" '${OpenClawWaitHandle}'
          fi

          echo "OpenClaw multi-tenant installation complete!"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-gateway"


# ===========================================================================
# Outputs
# ===========================================================================
Outputs:
  Step1InstallSSMPlugin:
    Description: "STEP 1: Install SSM Session Manager Plugin on your local computer"
    Value: "https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html"

  Step2PortForwarding:
    Description: "STEP 2: Run this command on LOCAL computer (keep terminal open)"
    Value: !Sub |
      aws ssm start-session --target ${OpenClawInstance} --region ${AWS::Region} --document-name AWS-StartPortForwardingSession --parameters '{"portNumber":["18789"],"localPortNumber":["18789"]}'

  Step3GetToken:
    Description: "STEP 3: Get Gateway Token"
    Value: !Sub |
      aws ssm get-parameter --name "/openclaw/${AWS::StackName}/gateway-token" --region ${AWS::Region} --with-decryption --query 'Parameter.Value' --output text

  Step4AccessURL:
    Description: "STEP 4: Open this URL in browser"
    Value: !Select
      - 1
      - !Split
        - '":"'
        - !Select
          - 0
          - !Split
            - '"}'
            - !GetAtt OpenClawWaitCondition.Data

  Step5StartChatting:
    Description: "STEP 5: Start using OpenClaw!"
    Value: "Connect WhatsApp, Telegram, Discord. See README: https://github.com/Vivek0712/OpenClaw-on-AWS-with-Bedrock"

  InstanceId:
    Description: "EC2 Instance ID (for reference)"
    Value: !Ref OpenClawInstance

  MultitenancyEcrRepositoryUri:
    Description: "ECR Repository URI for multi-tenancy agent container (build and push your Agent Container image here)"
    Value: !GetAtt MultitenancyEcrRepository.RepositoryUri
    Export:
      Name: !Sub "${AWS::StackName}-MultitenancyEcrRepositoryUri"

  AgentContainerExecutionRoleArn:
    Description: "ARN of the IAM role the Agent Container runs as inside AgentCore Runtime — pass this to 'aws bedrock-agentcore create-agent-runtime --role-arn'"
    Value: !GetAtt AgentContainerExecutionRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-AgentContainerExecutionRoleArn"

  GatewayEndpoint:
    Description: "EC2 Gateway public endpoint (openclaw gateway on port 18789)"
    Value: !Sub "http://${OpenClawInstance.PublicDnsName}:18789"
    Export:
      Name: !Sub "${AWS::StackName}-GatewayEndpoint"

  AuthAgentSystemPromptPath:
    Description: "SSM path for Authorization_Agent system prompt (update without redeployment)"
    Value: !Sub "/openclaw/${AWS::StackName}/auth-agent/system-prompt"
    Export:
      Name: !Sub "${AWS::StackName}-AuthAgentSystemPromptPath"

  TenantDefaultPermissionsPath:
    Description: "SSM path for default tenant permissions (basic profile)"
    Value: !Sub "/openclaw/${AWS::StackName}/tenants/default/permissions"
    Export:
      Name: !Sub "${AWS::StackName}-TenantDefaultPermissionsPath"

  AgentLogsGroupName:
    Description: "CloudWatch Log Group for agent invocations (use tenant_{tenant_id} stream prefix)"
    Value: !Ref AgentLogsGroup
    Export:
      Name: !Sub "${AWS::StackName}-AgentLogsGroupName"

  MonthlyCost:
    Description: "Estimated monthly cost (USD)"
    Value: !Sub |
      EC2 (${InstanceType}): ~$30-40
      EBS (30GB): ~$2.40
      VPC Endpoints: ${!If [CreateEndpoints, "~$22 ($0.01/hour per endpoint)", "$0"]}
      ECR (multitenancy): ~$0.10/GB/month storage
      CloudWatch Logs: Pay-per-use
      AgentCore Runtime: Pay-per-invocation (created separately)
      Bedrock: Pay-per-use
      Total: ~${!If [CreateEndpoints, "$55-65", "$33-43"]}/month + usage
